clear
clc

% Playing around with designing what a linear observer would look like if
% we had estimates for all of the states

run('quadrocopter_LQR.m')

C = eye(12);
ctrlr_poles = eig(A-B*K);

% From https://ecal.berkeley.edu/files/ce295/CH02-StateEstimation.pdf
% ". A general rule-of-thumb is that the observer eigenvalues should be 
% placed 2-10 times faster than the slowest stable eigenvalue of the energy
% system itself."
slowest_ctrlr_pole = max(real(ctrlr_poles));
obsv_poles = 6*ctrlr_poles;
L = place((A-B*K)',C', obsv_poles)';
L_file = "/Users/tmcnama2/px4-19/Firmware/build/px4_sitl_default/tmp/rootfs/tgmL.txt";
writematrix(L,L_file,'Delimiter','tab')

obsv_ctrl_dynamics = @(t, x_ext) quadrotor_exact(t, x_ext, K, L, sensor_noise);
sensor_noise = 0.01*ones(12,1);

x0 = zeros(24,1);
% run2 values (run 1 was 15, 15 15)
x0(2) = x_init;
x0(4) =5;
x0(6) = 15;

quadrotorsys = @(t,x) quadrotor_exact(t,x,K);
[t, x] = ode45(quadrotorsys, [0, 30], x0);
u_norm = zeros(4,length(t));
u = zeros(4,length(t));
for i = 1:length(t)
    [u(:,i), u_norm(:,i)] = lqr_control(x(i,:), K);
end

